name: Lighthouse CI

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      url:
        description: "URL to run Lighthouse on"
        required: false
        default: "http://localhost:8080"

permissions:
  issues: write
  contents: read

jobs:
  lighthouse-audit:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Build Project
        run: npm run build

      - name: Install Lighthouse CI
        # http-server ì„¤ì¹˜ ì œê±°, lhcië§Œ ì„¤ì¹˜
        run: npm install -g @lhci/cli@0.14.x

      - name: Run Lighthouse CI
        id: lighthouse
        continue-on-error: true
        run: |
          # 1ì¸ìì˜ íŒ: ì§ì ‘ ì„œë²„ë¥¼ ë„ìš°ì§€ ì•Šê³ , ë¹Œë“œëœ í´ë”(./dist)ë¥¼ ì§€ì •í•˜ë©´ 
          # LHCIê°€ ì•Œì•„ì„œ ë‚´ë¶€ ì„œë²„ë¥¼ ë„ìš°ê³  ì¸¡ì •í•©ë‹ˆë‹¤. í›¨ì”¬ ì•ˆì •ì ì…ë‹ˆë‹¤.
          lhci autorun --collect.staticDistDir=./dist --collect.numberOfRuns=3

      - name: Report Results to GitHub Issue
        if: always()
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            const LHCI_DIR = '.lighthouseci';

            // ... (ì´í•˜ ìŠ¤í¬ë¦½íŠ¸ ë‚´ìš©ì€ ê¸°ì¡´ê³¼ ë™ì¼í•˜ë¯€ë¡œ ê·¸ëŒ€ë¡œ ë‘ì…”ë„ ë©ë‹ˆë‹¤)
            // ì•„ë˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ì˜ ë‚˜ë¨¸ì§€ ë¶€ë¶„ì…ë‹ˆë‹¤. ë³µë¶™ í¸ì˜ë¥¼ ìœ„í•´ ë‹¤ì‹œ ë„£ì–´ë“œë¦½ë‹ˆë‹¤.

            const THRESHOLDS = {
              LCP: { good: 2500, poor: 4000 },
              INP: { good: 200, poor: 500 },
              CLS: { good: 0.1, poor: 0.25 },
            };

            const getLatestReport = () => {
              try {
                const jsonReports = fs.readdirSync(LHCI_DIR).filter(f => f.endsWith('.json'));
                if (!jsonReports.length) return null;
                const latestReport = jsonReports.sort().reverse()[0];
                return JSON.parse(fs.readFileSync(path.join(LHCI_DIR, latestReport), 'utf8'));
              } catch (e) {
                console.error('Failed to read report:', e);
                return null;
              }
            };

            const formatScore = (val) => Math.round((val || 0) * 100);

            const getStatusIcon = (val, metric) => {
              if (!metric) return val >= 90 ? 'ğŸŸ¢ Excellent' : val >= 50 ? 'ğŸŸ  Average' : 'ğŸ”´ Poor';
              const t = THRESHOLDS[metric];
              if (val <= t.good) return 'ğŸŸ¢ Good';
              if (val <= t.poor) return 'ğŸŸ  Needs Improvement';
              return 'ğŸ”´ Poor';
            };

            const formatMetricValue = (val, metric) => {
              if (val === undefined || val === null) return '-';
              if (metric === 'CLS') return val.toFixed(3);
              return `${(val / 1000).toFixed(2)}s`;
            };

            const generateMentoring = (webVitals, scores) => {
              let advice = [];
              if (webVitals.LCP > THRESHOLDS.LCP.good) {
                advice.push(`### ğŸ¢ **LCP ê°œì„ ì´ ì‹œê¸‰í•©ë‹ˆë‹¤! (${formatMetricValue(webVitals.LCP, 'LCP')})**`);
                advice.push(`- **API í˜¸ì¶œ ì ê²€**: \`Promise.all\`ì„ ì‚¬ìš©í•˜ê³  ìˆì§€ë§Œ, ë‚´ë¶€ì—ì„œ \`await\`ë¡œ ì¸í•´ ì§ë ¬(Waterfall) ì²˜ë¦¬ê°€ ë˜ê³  ìˆëŠ”ì§€ í™•ì¸í•´ë³´ì„¸ìš”.`);
                advice.push(`- **ì´ˆê¸° ë¡œë”©**: ë¶ˆí•„ìš”í•˜ê²Œ ì¤‘ë³µ í˜¸ì¶œë˜ëŠ” APIê°€ ì—†ëŠ”ì§€ \`fetch\` í•¨ìˆ˜ë“¤ì„ ì ê²€í•˜ì„¸ìš”.`);
              }
              if (webVitals.INP > THRESHOLDS.INP.good || scores.performance < 0.9) {
                 advice.push(`### ğŸŒ **ë°˜ì‘ì„±ì´ ë–¨ì–´ì§‘ë‹ˆë‹¤ (INP/TBT ê²½ê³ )**`);
                 advice.push(`- **í•„í„°ë§ ì—°ì‚°**: \`SearchDialog\`ì˜ \`getFilteredLectures\` í•¨ìˆ˜ê°€ ë§¤ ë Œë”ë§ë§ˆë‹¤ ì‹¤í–‰ë˜ë‚˜ìš”? **\`useMemo\`** ë„ì…ì„ ê°•ë ¥ ì¶”ì²œí•©ë‹ˆë‹¤.`);
                 advice.push(`- **ë¦¬ë Œë”ë§**: ê²€ìƒ‰ì–´ ì…ë ¥ ì‹œ í…Œì´ë¸”ì˜ ëª¨ë“  Rowê°€ ë‹¤ì‹œ ê·¸ë ¤ì§€ë‚˜ìš”? **\`React.memo\`**ì™€ **\`useCallback\`**ìœ¼ë¡œ í•˜ìœ„ ì»´í¬ë„ŒíŠ¸ë¥¼ ë³´í˜¸í•˜ì„¸ìš”.`);
              }
              if (webVitals.CLS > THRESHOLDS.CLS.good) {
                 advice.push(`### ğŸ— **í™”ë©´ì´ ëœì»¥ê±°ë¦½ë‹ˆë‹¤ (CLS ê²½ê³ )**`);
                 advice.push(`- **ë¡œë”© ì²˜ë¦¬**: ë°ì´í„°ê°€ ë¡œë”©ë˜ê¸° ì „ê³¼ í›„ì˜ ë ˆì´ì•„ì›ƒ ë†’ì´ê°€ ê³ ì •ë˜ì–´ ìˆë‚˜ìš”? ìŠ¤ì¼ˆë ˆí†¤ UIë‚˜ \`min-height\`ë¥¼ í™•ì¸í•˜ì„¸ìš”.`);
              }
              if (advice.length === 0) {
                advice.push(`### ğŸ‰ **ì™„ë²½í•©ë‹ˆë‹¤! ìë°”ìŠ¤í¬ë¦½íŠ¸ 1ì¸ìì˜ ì¹­í˜¸ë¥¼ ì–»ìœ¼ì…¨êµ°ìš”.**`);
                advice.push(`ë” ì´ìƒ ìµœì í™”í•  ê³³ì´ ì—†ì–´ ë³´ì…ë‹ˆë‹¤. ì•„ì£¼ í›Œë¥­í•œ ì½”ë“œì…ë‹ˆë‹¤.`);
              }
              return advice.join('\n');
            };

            const report = getLatestReport();

            if (!report) {
              console.log('No Lighthouse report found.');
              return;
            }

            const categories = report.categories || {};
            const audits = report.audits || {};

            const scores = {
              performance: categories.performance?.score,
              accessibility: categories.accessibility?.score,
              bestPractices: categories['best-practices']?.score,
              seo: categories.seo?.score,
              pwa: categories.pwa?.score,
            };

            const webVitals = {
              LCP: audits['largest-contentful-paint']?.numericValue,
              INP: audits['experimental-interaction-to-next-paint']?.numericValue ?? audits['interactive']?.numericValue,
              CLS: audits['cumulative-layout-shift']?.numericValue,
            };

            const now = new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });
            const mentoringMessage = generateMentoring(webVitals, scores);

            const body = `
            ## âš¡ï¸ Lighthouse Performance Report
            > ğŸ“… ì¸¡ì • ì¼ì‹œ: **${now}**

            ### ğŸ’¡ 1ì¸ìì˜ ì„±ëŠ¥ ì½”ì¹­ (Action Items)
            ${mentoringMessage}

            ---

            ### ğŸ† Overall Scores
            | Category | Score | Status |
            |:---:|:---:|:---|
            | **Performance** | **${formatScore(scores.performance)}** | ${getStatusIcon(formatScore(scores.performance))} |
            | **Accessibility** | **${formatScore(scores.accessibility)}** | ${getStatusIcon(formatScore(scores.accessibility))} |
            | **Best Practices** | **${formatScore(scores.bestPractices)}** | ${getStatusIcon(formatScore(scores.bestPractices))} |

            ### ğŸ“Š Core Web Vitals
            | Metric | Value | Status |
            |:---:|:---:|:---|
            | **LCP** | **${formatMetricValue(webVitals.LCP, 'LCP')}** | ${getStatusIcon(webVitals.LCP, 'LCP')} |
            | **INP (TBT)** | **${formatMetricValue(webVitals.INP, 'INP')}** | ${getStatusIcon(webVitals.INP, 'INP')} |
            | **CLS** | **${formatMetricValue(webVitals.CLS, 'CLS')}** | ${getStatusIcon(webVitals.CLS, 'CLS')} |

            <details>
            <summary>ğŸ“š ìƒì„¸ ê¸°ì¤€ê°’ ë³´ê¸°</summary>

            - **LCP**: < 2.5s (Good) / < 4.0s (Needs Improvement)
            - **INP**: < 200ms (Good) / < 500ms (Needs Improvement)
            - **CLS**: < 0.1 (Good) / < 0.25 (Needs Improvement)
            </details>
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš€ ì„±ëŠ¥ ë¦¬í¬íŠ¸ & ë©˜í† ë§ [${now}]`,
              body: body,
              labels: ['lighthouse', 'performance']
            });
